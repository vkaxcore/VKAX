# .github/workflows/build.yaml
name: CI • Production builds (Android + Native)

on:
  push:
    branches: ["v100.11.5-android"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  ANDROID_SDK_ROOT: ${{ github.workspace }}/.android-sdk
  ANDROID_HOME: ${{ github.workspace }}/.android-sdk
  ANDROID_CLT_LINUX: https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
  ANDROID_NDK_VERSION: "23.1.7779620"

################################################################################
# Android (cross compile) - its own matrix
# - Add rows to matrix.include to test more API/OS combos later.
################################################################################
jobs:
  android:
    name: android • build • ${{ matrix.id }}
    runs-on: ${{ matrix.runs_on }}
    timeout-minutes: 90
    strategy:
      matrix:
        include:
          # safe single canonical Android build target (change later if needed)
          - id: ubuntu-24-api34
            runs_on: ubuntu-24.04
            api: "34"
            ndk: "${{ env.ANDROID_NDK_VERSION }}"
            abi: "arm64-v8a"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Prepare SDK + cmdline-tools
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools" "$HOME/.android"
          touch "$HOME/.android/repositories.cfg"
          if [ ! -d "$ANDROID_SDK_ROOT/cmdline-tools/latest" ]; then
            tmp=$(mktemp -d)
            curl -fsSL "$ANDROID_CLT_LINUX" -o "$tmp/cmdline.zip"
            unzip -q "$tmp/cmdline.zip" -d "$ANDROID_SDK_ROOT/cmdline-tools"
            mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          fi
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"

      - name: Accept Android licenses
        uses: ./.github/actions/android-accept-licenses

      - name: Install Android SDK / NDK / Platform
        shell: bash
        run: |
          set -euo pipefail
          sdk="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          "$sdk" --sdk_root="${ANDROID_SDK_ROOT}" "platform-tools" "platforms;android-${{ matrix.api }}" "ndk;${{ matrix.ndk }}"

      - name: Build vendored depends (Android)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d depends ]; then
            echo "::error::depends/ directory missing; required for Android native build."
            exit 2
          fi
          J=$(nproc 2>/dev/null || echo 2); [ "$J" -gt 8 ] && J=8
          make -C depends -j"$J" HOST=aarch64-linux-android ANDROID_API_LEVEL=${{ matrix.api }} \
            ANDROID_SDK="${ANDROID_SDK_ROOT}" ANDROID_NDK="${ANDROID_SDK_ROOT}/ndk/${{ matrix.ndk }}"

      - name: Build native Android targets (daemon + cli)
        shell: bash
        run: |
          set -euo pipefail
          J=$(nproc 2>/dev/null || echo 2); [ "$J" -gt 8 ] && J=8
          export ANDROID_SDK="${ANDROID_SDK_ROOT}"
          export ANDROID_NDK="${ANDROID_SDK_ROOT}/ndk/${{ matrix.ndk }}"
          export ANDROID_API_LEVEL=${{ matrix.api }}
          export ANDROID_TOOLCHAIN_BIN="${ANDROID_NDK}/toolchains/llvm/prebuilt/linux-x86_64/bin"
          make -C . -j"$J" V=1 HOST=aarch64-linux-android ANDROID_API_LEVEL=${ANDROID_API_LEVEL} \
            ANDROID_TOOLCHAIN_BIN=${ANDROID_TOOLCHAIN_BIN} vkax-d vkax-cli || true

      - name: Attempt Qt packaging (if available in depends)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist_apk
          QMAKE=$(find depends -type f -name 'qmake' -o -name 'qmake-qt5' 2>/dev/null | head -n1 || true)
          ANDROIDDEPLOYQT=$(find depends -type f -name 'androiddeployqt' 2>/dev/null | head -n1 || true)
          if [ -n "$QMAKE" ] && [ -n "$ANDROIDDEPLOYQT" ] && [ -f src/qt/vkax-qt.pro ]; then
            mkdir -p build-qt-android && cd build-qt-android
            "$QMAKE" ../src/qt/vkax-qt.pro ANDROID_ABIS=${{ matrix.abi }} ANDROID_PLATFORM=android-${{ matrix.api }} || true
            make -j"$(nproc || echo 2)" || true
            JSON=$(find . -name android_deployment_settings.json -print -quit || true)
            if [ -n "$JSON" ]; then
              "$ANDROIDDEPLOYQT" --input "$JSON" --output ./android_deploy --android-platform android-${{ matrix.api }} --gradle --release || true
              find ./android_deploy -type f -name '*.apk' -exec cp -a {} ../dist_apk/ \; || true
            fi
          else
            echo "::notice::androiddeployqt/qmake not available; skipping deterministic Qt packaging."
          fi

      - name: Collect Android artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist_android
          cp -a dist_apk/* dist_android/ 2>/dev/null || true
          find build -type f -name 'vkax-*' -exec cp -a {} dist_android/ \; || true
          if [ -d dist_android ]; then (cd dist_android && sha256sum * > sha256sums.txt || true); fi

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-${{ matrix.id }}
          path: |
            dist_android/**/*
            build/**/*
          if-no-files-found: warn

################################################################################
# macOS native (own matrix)
################################################################################
  macos:
    name: native • macOS • ${{ matrix.macos }}
    runs-on: ${{ matrix.macos }}
    timeout-minutes: 60
    strategy:
      matrix:
        macos: [macos-13]  # macOS-13 (Intel) as requested
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build vendored depends (macOS)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d depends ]; then echo "::error::depends/ directory missing; required for macOS build."; exit 2; fi
          brew update
          brew install automake libtool pkg-config cmake ninja || true
          J=$(sysctl -n hw.ncpu 2>/dev/null || echo 2); [ "$J" -gt 8 ] && J=8
          make -C depends -j"$J" HOST=x86_64-apple-darwin || true

      - name: CMake build (macOS)
        shell: bash
        run: |
          set -euo pipefail
          export CMAKE_PREFIX_PATH="$(echo depends/x86_64-apple-darwin* 2>/dev/null || true)"
          cmake -S . -B build -G Ninja
          cmake --build build -j"$(sysctl -n hw.ncpu 2>/dev/null || echo 2)" || true

      - name: Collect macOS binaries
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist_macos
          find build -type f -perm -111 -name 'vkax*' -exec cp -a {} dist_macos/ \; || true
          if [ -d dist_macos ]; then (cd dist_macos && sha256sum * > sha256sums.txt || true); fi

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: native-macos-${{ matrix.macos }}
          path: |
            dist_macos/**/*
            build/**/*
          if-no-files-found: warn

################################################################################
# Ubuntu / Linux matrix (amd64 + arm hosted labels)
# - Add rows to matrix.include for new Ubuntu versions / labels.
################################################################################
  ubuntu:
    name: native • ubuntu • ${{ matrix.name }}
    runs-on: ${{ matrix.runs_on }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-22-amd64
            runs_on: ubuntu-22.04
            triple: x86_64-pc-linux-gnu
            allow_failures: false
          - name: ubuntu-24-amd64
            runs_on: ubuntu-24.04
            triple: x86_64-pc-linux-gnu
            allow_failures: false
          - name: ubuntu-22-arm64
            runs_on: ubuntu-22.04-arm
            triple: aarch64-linux-gnu
            allow_failures: true
          - name: ubuntu-24-arm64
            runs_on: ubuntu-24.04-arm
            triple: aarch64-linux-gnu
            allow_failures: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build vendored depends (Linux)
        shell: bash
        run: |
          set -euo pipefail
          if [ -d depends ]; then
            sudo apt-get update -qq
            sudo apt-get install -y -qq build-essential pkg-config automake libtool autoconf bison cmake ninja-build python3 || true
            J=$(nproc 2>/dev/null || echo 2); [ "$J" -gt 8 ] && J=8
            make -C depends -j"$J" HOST=${{ matrix.triple }} || true
          else
            echo "::notice::No depends/ dir; skipping vendored deps."
          fi

      - name: CMake build (Linux)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f CMakeLists.txt ]; then
            echo "::notice::No CMakeLists.txt; skipping."; exit 0
          fi
          if [ -d "depends/${{ matrix.triple }}" ]; then
            export CMAKE_PREFIX_PATH="depends/${{ matrix.triple }}"
          else
            echo "::warning::Vendored depends prefix not found; continuing without depends.";
          fi
          cmake -S . -B build -G Ninja
          cmake --build build -j"$(nproc || echo 2)" || true

      - name: Collect Linux binaries
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist_linux
          find build -type f -perm -111 -name 'vkax*' -exec cp -a {} dist_linux/ \; || true
          if [ -d dist_linux ]; then (cd dist_linux && sha256sum * > sha256sums.txt || true); fi

      - name: Upload linux artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: native-ubuntu-${{ matrix.name }}
          path: |
            dist_linux/**/*
            build/**/*
          if-no-files-found: warn

################################################################################
# Windows native (MSVC) — single matrix
################################################################################
  windows:
    name: native • windows • ${{ matrix.windows }}
    runs-on: ${{ matrix.windows }}
    timeout-minutes: 45
    strategy:
      matrix:
        windows: [windows-2022]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC env
        uses: ilammy/msvc-dev-cmd@v1

      - name: CMake build (MSVC)
        shell: powershell
        run: |
          if (Test-Path .\CMakeLists.txt) {
            cmake -S . -B build -G "Visual Studio 17 2022" -A x64
            cmake --build build --config Release -- /m:2
          } else {
            Write-Output "::notice::No CMakeLists.txt; skipping."
          }

      - name: Collect Windows binaries
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path dist_win | Out-Null
          Get-ChildItem -Path build -Filter "vkax*" -Recurse -File | ForEach-Object { Copy-Item -Path $_.FullName -Destination dist_win }

      - name: Upload windows artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: native-windows-${{ matrix.windows }}
          path: |
            dist_win/**/*
            build/**/*
          if-no-files-found: warn

################################################################################
# Windows cross (MinGW on Ubuntu) — separate job
################################################################################
  windows_cross:
    name: native • windows-cross • ubuntu-22.04
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Tooling
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y -qq build-essential pkg-config automake libtool autoconf bison cmake ninja-build python3 g++-mingw-w64-x86-64 || true

      - name: Build depends (x86_64-w64-mingw32)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d depends ]; then echo "::error::depends/ missing"; exit 2; fi
          J=$(nproc 2>/dev/null || echo 2); [ "$J" -gt 8 ] && J=8
          make -C depends -j"$J" HOST=x86_64-w64-mingw32 || true

      - name: CMake configure and build (MinGW)
        shell: bash
        run: |
          set -euo pipefail
          export CMAKE_PREFIX_PATH="$(echo depends/x86_64-w64-mingw32* 2>/dev/null || true)"
          cmake -S . -B build-w64 -G Ninja || true
          cmake --build build-w64 -j"$(nproc || echo 2)" || true

      - name: Collect Windows cross .exe
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist-w64
          find build-w64 -type f -name 'vkax-*.exe' -exec cp -a {} dist-w64/ \; || true
          if [ -d dist-w64 ]; then (cd dist-w64 && sha256sum * > sha256sums.txt || true); fi

      - name: Upload Windows cross artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: native-windows-cross-ubuntu-22.04
          path: |
            dist-w64/**/*
            build-w64/**/*
          if-no-files-found: warn
