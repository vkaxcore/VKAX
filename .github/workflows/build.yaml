name: VKAX macOS Build
on:
  workflow_dispatch:
  push:
    branches: [ main, v100.11.5-macbuild, dev ]

env:
  COIN_NAME: vkax
  BUILD_DIR: vkax-build
  COMPRESS_DIR: vkax-compress

jobs:
  build-macos:
    name: Build VKAX macOS 13
    runs-on: macos-13

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Tooling
        run: |
          brew update
          brew install automake libtool pkg-config miniupnpc librsvg libnatpmp zeromq python@3.13
          python3 -m pip install -U pip setuptools ds_store mac_alias

      - name: Build depends (Qt 5.15.10)
        env:
          # Do NOT override with custom mirrors; use upstream.
          FALLBACK_DOWNLOAD_PATH: ""
        run: |
          set -euo pipefail
          echo "Building dependsâ€¦"
          make -C depends -j8 HOST=x86_64-apple-darwin22.6.0

      - name: Configure VKAX
        env:
          CONFIG_SITE: ${{ github.workspace }}/depends/x86_64-apple-darwin22.6.0/share/config.site
        run: |
          set -euo pipefail
          ./autogen.sh
          ./configure \
            --prefix="${PWD}/depends/x86_64-apple-darwin22.6.0" \
            --with-incompatible-bdb \
            --disable-tests \
            CXXFLAGS="-std=c++14"

      - name: Build
        run: |
          set -euo pipefail
          make -j8
          mkdir -p "${BUILD_DIR}"
          cp src/{vkax-cli,vkaxd,qt/vkax-qt} "${BUILD_DIR}/"
          strip "${BUILD_DIR}"/*

      - name: Package
        run: |
          set -euo pipefail
          mkdir -p "${COMPRESS_DIR}"
          tar -cvzf "${COMPRESS_DIR}/${COIN_NAME}-macos13.tar.gz" -C "${BUILD_DIR}" .

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.COIN_NAME }}-macos13-build
          path: ${{ env.COMPRESS_DIR }}/${{ env.COIN_NAME }}-macos13.tar.gz
