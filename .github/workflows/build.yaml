name: Build VKAX macOS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-macos:
    runs-on: macos-13
    env:
      QT_VERSION: "5.9.6"
      DEPENDS_DIR: ${{ github.workspace }}/depends
      PATH: /usr/local/bin:$PATH

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          brew update
          brew install python@3.13 pkgconf libtool wget xz

      - name: Setup VKAX depends
        run: |
          mkdir -p $DEPENDS_DIR
          cd $DEPENDS_DIR
          wget https://github.com/vkaxcore/VKAX/archive/refs/heads/main.zip -O VKAX.zip
          unzip VKAX.zip
          cd ..

      - name: Fetch and build Qt cross-buildable
        run: |
          cd $DEPENDS_DIR
          # qt.mk should be placed under depends/qt.mk
          make -C . -f qt.mk

      - name: Build VKAX for macOS
        run: |
          cd ${{ github.workspace }}
          ./autogen.sh
          ./configure --prefix=$DEPENDS_DIR/build --with-qt-dir=$DEPENDS_DIR/qt
          make -j$(sysctl -n hw.logicalcpu)
          make install

      - name: Package
        run: |
          mkdir -p build_artifacts
          cp $DEPENDS_DIR/build/bin/vkaxd build_artifacts/
          ls -lh build_artifacts/
