name: VKAX Ubuntu Test Build

on:
  push:
    branches:
      - main
      - develop
      - v100.11.5
  pull_request:
    branches:
      - develop

env:
  COIN_NAME: vkax
  BUILD_DIR: vkax-build
  TEST_LOG_ARTIFACT_DIR: test-logs

jobs:
  build-ubuntu:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - uses: actions/checkout@v4

      # -------------------------
      # Install dependencies
      # -------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential libtool autotools-dev automake pkg-config python3 bsdmainutils cmake curl zip unzip libboost-all-dev
          if [[ "${{ matrix.arch }}" == "arm64" ]]; then
            sudo apt-get install -y g++-aarch64-linux-gnu
          fi

      # -------------------------
      # Build depends
      # -------------------------
      - name: Build depends
        run: |
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            make -C depends -j$(nproc)
          else
            make -C depends -j$(nproc) HOST=aarch64-linux-gnu
          fi

      # -------------------------
      # Configure with correct Boost
      # -------------------------
      - name: Configure
        run: |
          BOOST_LIB_DIR=$(pwd)/depends/${{ matrix.arch == 'x86_64' && echo 'x86_64-pc-linux-gnu' || echo 'aarch64-linux-gnu' }}/lib
          ./autogen.sh
          ./configure --prefix=$BOOST_LIB_DIR --with-boost-libdir=$BOOST_LIB_DIR

      # -------------------------
      # Build
      # -------------------------
      - name: Build VKAX
        run: make -j$(nproc)

      # -------------------------
      # Package
      # -------------------------
      - name: Package build
        run: |
          mkdir -p $BUILD_DIR
          mv src/{vkax-cli,vkaxd,qt/vkax-qt} $BUILD_DIR/ || true
          strip $BUILD_DIR/* || true
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            tar -czf ${COIN_NAME}-ubuntu-${{ matrix.arch }}.tar.gz $BUILD_DIR
            sha256sum ${COIN_NAME}-ubuntu-${{ matrix.arch }}.tar.gz > ${COIN_NAME}-ubuntu-${{ matrix.arch }}.sha256
          else
            tar -czf ${COIN_NAME}-arm64-${{ matrix.arch }}.tar.gz $BUILD_DIR
            sha256sum ${COIN_NAME}-arm64-${{ matrix.arch }}.tar.gz > ${COIN_NAME}-arm64-${{ matrix.arch }}.sha256
          fi

      # -------------------------
      # Upload artifacts
      # -------------------------
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.arch }}-ubuntu
          path: |
            ${{ matrix.arch == 'x86_64' && format('{0}-ubuntu-{1}.tar.gz\n{0}-ubuntu-{1}.sha256', env.COIN_NAME, matrix.arch) || format('{0}-arm64-{1}.tar.gz\n{0}-arm64-{1}.sha256', env.COIN_NAME, matrix.arch) }}
