name: VKAX Windows (cross via mingw-w64)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - dev
      - v100.11.5-windows

env:
  COIN_NAME: vkax
  BUILD_DIR: vkax-build
  COMPRESS_DIR: vkax-compress
  LC_ALL: C
  LANG: C

jobs:
  windows-cross:
    name: Windows x86_64 (Qt 5.15.10, cross)
    runs-on: ubuntu-22.04
    env:
      HOST: x86_64-w64-mingw32
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y automake libtool pkg-config make \
                                  mingw-w64 binutils-mingw-w64 g++-mingw-w64 \
                                  zip

      - name: Build depends (Qt 5.15.10)
        run: |
          make -C depends -j"$(nproc)" HOST=${HOST}

      - name: Configure (cross)
        env:
          CONFIG_SITE: ${{ github.workspace }}/depends/${{ env.HOST }}/share/config.site
        run: |
          ./autogen.sh || true
          ./configure \
            --host=${HOST} --build=$(gcc -dumpmachine) \
            --prefix="${PWD}/depends/${HOST}" \
            --with-incompatible-bdb \
            --with-gui=qt5 \
            --disable-tests --disable-bench \
            CXXFLAGS="-std=c++14"

      - name: Build
        run: make -j"$(nproc)"

      - name: Package
        run: |
          mkdir -p "$BUILD_DIR" "$COMPRESS_DIR"
          cp -f src/vkaxd.exe src/vkax-cli.exe src/qt/vkax-qt.exe "$BUILD_DIR/" || true
          zip -r "$COMPRESS_DIR/${COIN_NAME}-windows-x86_64.zip" "$BUILD_DIR"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.COIN_NAME }}-windows-x86_64
          path: ${{ env.COMPRESS_DIR }}/${{ env.COIN_NAME }}-windows-x86_64.zip
