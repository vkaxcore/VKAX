name: VKAX Android APK Build

on:
  workflow_dispatch:
  push:
    branches: [main, v100.11.5-android, dev]

env:
  COIN_NAME: vkax
  BUILD_DIR: vkax-build
  COMPRESS_DIR: vkax-compress
  LC_ALL: C
  LANG: C

jobs:
  android-apk:
    name: Android aarch64 build
    runs-on: ubuntu-22.04
    env:
      HOST: aarch64-linux-android
      ANDROID_API: "21"   # exported as ANDROID_API_LEVEL for depends/hosts/android.mk
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Debugging Environment Variables
        run: |
          echo "==== Debugging Environment Variables ===="
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo "ANDROID_NDK: $ANDROID_NDK"
          echo "ANDROID_API_LEVEL: $ANDROID_API_LEVEL"
          echo "PATH: $PATH"
          echo "==== End Debugging Environment Variables ===="

      - name: Strip out Windows PATH
        run: |
          PATH=$(echo "$PATH" | sed -e 's/:\/mnt.*//g')  # Remove problematic Windows %PATH% imported var

      - name: Build dependencies (Windows)
        run: |
          set -eux
          cd depends
          make HOST=x86_64-w64-mingw32
          cd ..

      - name: Ensure config.site exists
        run: |
          set -eux
          # Check for config.site existence and copy if necessary
          if [ ! -f "$PWD/depends/x86_64-w64-mingw32/share/config.site" ]; then
            echo "config.site not found, creating it manually"
            cp $PWD/depends/config.site.in $PWD/depends/x86_64-w64-mingw32/share/config.site
          fi

      - name: Run autogen.sh and configure
        run: |
          set -eux
          ./autogen.sh  # Run autogen.sh to generate necessary files
          CONFIG_SITE=$PWD/depends/x86_64-w64-mingw32/share/config.site ./configure --prefix=/

      - name: Build the project
        run: |
          set -eux
          make
